#!/bin/bash
# .githooks/pre-commit
#
# Pre-commit hook to prevent accidental secret commits
# Install with: git config core.hooksPath .githooks

RED='\033[0;31m'
NC='\033[0m'

echo "Running pre-commit security check..."

# Patterns that indicate actual secrets (not code that handles secrets)
SECRET_PATTERNS=(
    'password\s*[:=]\s*["\x27][^"\x27]+["\x27]'    # password: "actualvalue" or password = 'actualvalue'
    'token\s*[:=]\s*["\x27][^"\x27]+["\x27]'
    'api_key\s*[:=]\s*["\x27][^"\x27]+["\x27]'
    'secret\s*[:=]\s*["\x27][^"\x27]+["\x27]'
    'NTFY_TOPIC=[a-zA-Z0-9]+'                       # Filled env vars (not empty)
    'PUSHOVER_TOKEN=[a-zA-Z0-9]+'
    'PUSHOVER_USER=[a-zA-Z0-9]+'
    'TELEGRAM_TOKEN=[0-9]+:'
    'TELEGRAM_CHAT=[0-9]+'
    'HA_WEBHOOK=http'
    'mac:\s*"[0-9A-Fa-f]{2}:[0-9A-Fa-f]{2}:[0-9A-Fa-f]{2}:[0-9A-Fa-f]{2}:[0-9A-Fa-f]{2}:[0-9A-Fa-f]{2}"'  # Real MAC addresses
)

# Files to check (staged files only)
FILES=$(git diff --cached --name-only --diff-filter=ACM)

FOUND_SECRETS=0

for file in $FILES; do
    # Skip example files, this hook, and Python source code
    if [[ "$file" == *.example ]] || [[ "$file" == *pre-commit* ]]; then
        continue
    fi

    # Skip binary files
    if file "$file" 2>/dev/null | grep -q "binary"; then
        continue
    fi

    # Only check config files, not source code
    if [[ "$file" == *.py ]] || [[ "$file" == *.sh ]]; then
        continue
    fi

    for pattern in "${SECRET_PATTERNS[@]}"; do
        if grep -qiE "$pattern" "$file" 2>/dev/null; then
            echo -e "${RED}⚠️  Potential secret found in: $file${NC}"
            echo "   Pattern: $pattern"
            grep -niE "$pattern" "$file" | head -3
            FOUND_SECRETS=1
        fi
    done
done

# Check for specific sensitive files that should never be committed
SENSITIVE_FILES=(
    "config.yaml"
    ".env"
)

for sensitive_file in "${SENSITIVE_FILES[@]}"; do
    for file in $FILES; do
        if [[ "$(basename "$file")" == "$sensitive_file" ]]; then
            echo -e "${RED}⚠️  Sensitive file staged: $file${NC}"
            FOUND_SECRETS=1
        fi
    done
done

if [ $FOUND_SECRETS -eq 1 ]; then
    echo ""
    echo -e "${RED}❌ Commit blocked - potential secrets detected!${NC}"
    echo ""
    echo "If these are intentional (e.g., example values), you can bypass with:"
    echo "  git commit --no-verify"
    echo ""
    echo "Otherwise, please:"
    echo "  1. Remove secrets from staged files"
    echo "  2. Use config.yaml.example and .env.example for templates"
    echo "  3. Add real config files to .gitignore"
    exit 1
fi

echo "✅ No secrets detected"
exit 0