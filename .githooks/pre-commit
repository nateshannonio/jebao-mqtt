#!/bin/bash
# .githooks/pre-commit
#
# Pre-commit hook to prevent accidental secret commits
# Install with: git config core.hooksPath .githooks

RED='\033[0;31m'
NC='\033[0m'

echo "Running pre-commit security check..."

# Files to check (staged files only)
FILES=$(git diff --cached --name-only --diff-filter=ACM)

FOUND_SECRETS=0

# Check for specific sensitive files that should never be committed
SENSITIVE_FILES=(
    "config.yaml"
    ".env"
)

for sensitive_file in "${SENSITIVE_FILES[@]}"; do
    for file in $FILES; do
        if [[ "$(basename "$file")" == "$sensitive_file" ]]; then
            echo -e "${RED}⚠️  Sensitive file staged: $file${NC}"
            FOUND_SECRETS=1
        fi
    done
done

if [ $FOUND_SECRETS -eq 1 ]; then
    echo ""
    echo -e "${RED}❌ Commit blocked - sensitive files detected!${NC}"
    echo ""
    echo "These files contain secrets and should not be committed:"
    echo "  - config.yaml (contains pump MAC, MQTT credentials)"
    echo "  - .env (contains alert tokens)"
    echo ""
    echo "Use the .example versions as templates instead."
    echo ""
    echo "To bypass (if you know what you're doing):"
    echo "  git commit --no-verify"
    exit 1
fi

echo "✅ No secrets detected"
exit 0